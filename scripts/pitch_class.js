import{ColorScheme}from"./svg_generator.js";import{parsePitches,XLengthType}from"./pitch.js";import{PitchClassSvgGenerator}from"./pitch_class_svg.js";import{ColorControl}from"./color_palette.js";import{AudioSource}from"./sound.js";import{Monzo}from"./monzo.js";let textArea,checkboxQuantize,checkboxShowStep,textEdo,checkboxLimitInterval,textPrime,previewSvg,pitchClassSvgGenerator,colorControl,pitches=[],playingAudio=null;function addEventListnerById(e,t,o){const n=document.getElementById(e);n.addEventListener(t,()=>o(n))}function createSvgUrl(){const e=(new XMLSerializer).serializeToString(previewSvg),t=new Blob([e],{type:"image/svg+xml"});return URL.createObjectURL(t)}function playSound(){if(playingAudio?(playingAudio.pause(),playingAudio.currentTime=0):playingAudio=document.createElement("audio"),0===pitches.length)return;const e=checkboxQuantize.checked?Number(textEdo.value):0,t=pitches.filter(e=>!e.mute).map(t=>({monzo:t.originalMonzo.toPitchClassMonzo(),pitchClass:t.originalMonzo.quantizedPitchClass(e)}));t.sort((e,t)=>e.pitchClass-t.pitchClass);const o=t.filter((e,t,o)=>0===t||e.pitchClass!==o[t-1].pitchClass);0!==o.length&&(o.push({monzo:Monzo.from2Factor(1),pitchClass:0}),playingAudio.src=AudioSource.createFromMonzoSerial(o.map(e=>e.monzo),220,.5,e),playingAudio.play())}function downloadSvg(e){e.href=createSvgUrl()}function downloadPng(){const e=document.createElement("img");e.src=createSvgUrl();const t=document.createElement("canvas");t.width=previewSvg.viewBox.baseVal.width,t.height=previewSvg.viewBox.baseVal.height;const o=t.getContext("2d");e.onload=()=>{o?.drawImage(e,0,0);const n=document.createElement("a");n.href=t.toDataURL("image/png"),n.setAttribute("download","chordGraph.png"),n.dispatchEvent(new MouseEvent("click"))}}function loadMonzo(){pitches=parsePitches(textArea.value,!0,XLengthType.Integer),pitchClassSvgGenerator.generate(pitches,{quantizeEdo:checkboxQuantize.checked?Number(textEdo.value):0,showSteps:checkboxShowStep.checked,autoCompleteLimitInterval:checkboxLimitInterval.checked?Number(textPrime.value):0})}window.addEventListener("load",()=>{textArea=document.getElementById("textarea_editor"),checkboxQuantize=document.getElementById("checkbox_quantize"),checkboxShowStep=document.getElementById("checkbox_show_step"),checkboxLimitInterval=document.getElementById("checkbox_limit_interval"),textEdo=document.getElementById("text_edo"),textPrime=document.getElementById("text_prime"),previewSvg=document.getElementById("preview_figure");const e=document.getElementById("editor_preview"),t=previewSvg.getElementById("line_group"),o=previewSvg.getElementById("grid"),n=previewSvg.getElementById("pitch_class_group");colorControl=new ColorControl(e,new ColorScheme,()=>loadMonzo()),pitchClassSvgGenerator=new PitchClassSvgGenerator(previewSvg,o,t,n,colorControl.colorScheme),textArea.addEventListener("input",()=>loadMonzo()),addEventListnerById("a_download_svg","click",downloadSvg),addEventListnerById("a_download_png","click",downloadPng),addEventListnerById("button_play","click",playSound);const i=[textArea,checkboxQuantize,checkboxShowStep,checkboxLimitInterval,textEdo,textPrime];for(const e of i)e.addEventListener("input",()=>loadMonzo());loadMonzo()});