import{clearChildren,createCircle,createLine,setCenter}from"./svg_generator.js";const generatorColors=["#DF4121","#339564","#217BDF","#C3B827"];class Representation{static charMap=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p"];static getChar(e){return e<this.charMap.length?this.charMap[e]:String.fromCodePoint(65+e)}static getAlternating(e,t,n){const r=this.getChar(e),o=this.getChar(t),s=new Array(n),i=new Array(n);for(let e=0;e<n;e++)e%2==0?(s[e]=r,i[e]=o):(s[e]=o,i[e]=r);return[s.join(""),i.join("")]}static getAlternatingNumbers(e,t,n){const r=new Array(n),o=new Array(n);for(let s=0;s<n;s++)s%2==0?(r[s]=e,o[s]=t):(r[s]=t,o[s]=e);return[r,o]}}export class CoxeterMatrix{values;dimension;constructor(e){this.values=e;const t=this.values.length;this.dimension=Math.sqrt(2*t+.25)+.5}get(e,t){if(e==t)return 2;const n=e>t?e*(e-1)/2+t:t*(t-1)/2+e;return this.values[n]??2}getExchanges(){const e=new Map;for(let t=0;t<this.dimension;t++)for(let n=t+1;n<this.dimension;n++){const r=this.get(t,n),[o,s]=Representation.getAlternating(t,n,r);e.set(o,s),e.set(s,o)}return e}getExchanges2(){const e=new Array(3);for(let t=0;t<this.dimension;t++)e[t]=[];for(let t=0;t<this.dimension;t++)for(let n=t+1;n<this.dimension;n++){const r=this.get(t,n),[o,s]=Representation.getAlternatingNumbers(t,n,r);e[t]?.push({from:o,to:s}),e[n]?.push({from:s,to:o})}return e}static create2D(e){return new CoxeterMatrix([e])}static create3D(e,t,n){return new CoxeterMatrix([e,n??2,t])}static create4D(e,t,n){return new CoxeterMatrix([e,2,t,2,2,n])}static create4DDemicube(e,t,n){return new CoxeterMatrix([e,t,2,n,2,2])}}export class CoxeterGroup{ranks;constructor(e){const t=e.getExchanges2();console.log(t);const n={index:0,rank:0,representation:"",neighbors:new Array(e.dimension)};this.ranks=[[n]];let r=0,o=1;const s=e.dimension>=4?14401:121,i=e.dimension>=4?31:13;for(;;){const n=this.ranks.length;console.log(`探索: rank${n}`);const a=this.ranks[n-1],c=[];for(const r of a)for(let s=0;s<e.dimension;s++){if(r.neighbors[s])continue;const i=r.representation+Representation.getChar(s);let a;for(const e of t[s]){let t=CoxeterGroup.#e(r,e.from,1);if(t&&(a=c.find(n=>t===CoxeterGroup.#e(n,e.to)),a))break}a||(a={index:o,rank:n,representation:i,neighbors:new Array(e.dimension)},c.push(a),o++),a.neighbors[s]=r,r.neighbors[s]=a}if(console.log(`追加要素数: ${c.length}`),this.ranks.push(c),r+=c.length,r>=s||n>=i&&c.length>=this.ranks[this.ranks.length-2].length)break;if(1==c.length&&c[0].neighbors.every(e=>!!e))break}n.representation="1"}static#e(e,t,n){let r=e;for(let e=n??0;e<t.length;e++){const n=r.neighbors[t[e]];if(!n||n.rank>r.rank)return null;r=n}return r}}window.addEventListener("load",()=>{const e=document.getElementById("textarea_editor"),t=document.getElementById("button_log"),n=document.getElementById("preview_figure"),r=document.getElementById("line_group"),o=document.getElementById("element_group");t.addEventListener("click",()=>{let t=e.value;const s=t.startsWith("d");s&&(t=t.slice(1));const i=t.split(" ").filter(e=>e.length>0).map(e=>parseInt(e)),a=new CoxeterGroup(1==i.length?CoxeterMatrix.create2D(i[0]):2==i.length?CoxeterMatrix.create3D(i[0],i[1]):3==i.length?s?CoxeterMatrix.create4DDemicube(i[0],i[1],i[2]):CoxeterMatrix.create4D(i[0],i[1],i[2]):CoxeterMatrix.create3D(2,2)),c=a.ranks.reduce((e,t)=>e+t.length,0);console.log(`order: ${c}`);const l=new Map;let g=0;for(let e=0;e<a.ranks.length;e++){const t=a.ranks[e],n=40*(t.length-1);g=Math.max(g,n);const r=-n/2,o=40*e;for(let e=0;e<t.length;e++){const n=t[e];l.set(n,{x:r+40*e,y:o})}}const h=g+60+12,u=40*(a.ranks.length-1)+60+12;setCenter(h/2,36),clearChildren(r,o);for(const e of a.ranks)for(const t of e){const e=l.get(t);for(let n=0;n<t.neighbors.length;n++){const o=t.neighbors[n];if(!o||o.rank<=t.rank)continue;const s=l.get(o),i=generatorColors[n]??"#000000",a=createLine(e.x,e.y,s.x,s.y,i,"4");r.appendChild(a)}}for(const e of a.ranks)for(const t of e){const e=l.get(t),n=createCircle(e.x,e.y,6,"#FFFFFF","#000000","2");o.appendChild(n)}n.setAttribute("viewBox",`0 0 ${h} ${u}`)})});