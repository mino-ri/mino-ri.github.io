import{clearChildren,createCircle,createLine,setCenter}from"./svg_generator.js";const generatorColors=["#DF4121","#339564","#217BDF","#C3B827"],directionMap=new Map([[2,[[1,0],[0,1]]]]),positionCenter=200;class Vectors{static dot(e,t){let r=0;const n=Math.min(e.length,t.length);for(let o=0;o<n;o++)r+=e[o]*t[o];return r}static mul(e,t){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=e[n]*t;return r}static add(e,t){const r=Math.min(e.length,t.length),n=new Array(r);for(let o=0;o<r;o++)n[o]=e[o]+t[o];return n}static sub(e,t){const r=Math.min(e.length,t.length),n=new Array(r);for(let o=0;o<r;o++)n[o]=e[o]-t[o];return n}static project(e){const t=e.length;switch(t){case 0:return{x:0,y:0,z:1};case 1:return{x:150*e[0],y:0,z:1};case 2:return{x:150*e[0],y:-150*e[1],z:1}}let r=directionMap.get(t);if(!r){r=new Array(t);for(let e=0;e<t;e++){const n=2*Math.PI*(t-e-1)/t;r[e]=[150*Math.sin(n),150*-Math.cos(n)]}directionMap.set(t,r)}let n={x:0,y:0,z:0};for(let o=0;o<t;o++){const t=e[o],[s,i]=r[o];n.x+=t*s,n.y+=t*i,n.z+=t}return n.z=(n.z/t+2)/2,n.x=n.x*n.z,n.y=n.y*n.z,n}}class Mirror{normal;constructor(e){this.normal=e}reflection(e){const t=-2*Vectors.dot(e,this.normal);return Vectors.add(e,Vectors.mul(this.normal,t))}}class Representation{static beginCodePoint=97;static charMap=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p"];static getChar(e){return e<this.charMap.length?this.charMap[e]:String.fromCodePoint(Representation.beginCodePoint+e)}static getAlternating(e,t,r){const n=this.getChar(e),o=this.getChar(t),s=new Array(r),i=new Array(r);for(let e=0;e<r;e++)e%2==0?(s[e]=n,i[e]=o):(s[e]=o,i[e]=n);return[s.join(""),i.join("")]}static getAlternatingNumbers(e,t,r){const n=new Array(r),o=new Array(r);for(let s=0;s<r;s++)s%2==0?(n[s]=e,o[s]=t):(n[s]=t,o[s]=e);return[n,o]}}export class CoxeterMatrix{values;dimension;constructor(e){this.values=e;const t=this.values.length;this.dimension=Math.sqrt(2*t+.25)+.5}get(e,t){if(e==t)return 2;const r=e>t?e*(e-1)/2+t:t*(t-1)/2+e;return this.values[r]??2}getExchanges(){const e=new Array(3);for(let t=0;t<this.dimension;t++)e[t]=[];for(let t=0;t<this.dimension;t++)for(let r=t+1;r<this.dimension;r++){const n=this.get(t,r),[o,s]=Representation.getAlternatingNumbers(t,r,n);e[t]?.push({from:o,to:s}),e[r]?.push({from:s,to:o})}return e}static create2D(e){return new CoxeterMatrix([e])}static create3D(e,t,r){return new CoxeterMatrix([e,r??2,t])}static create4D(e,t,r){return new CoxeterMatrix([e,2,t,2,2,r])}static create4DDemicube(e,t,r){return new CoxeterMatrix([e,t,2,r,2,2])}}const dummyPosition=[];export class CoxeterGroupElement{index;rank;representation;neighbors;#e;position;constructor(e,t,r,n){this.index=e,this.rank=t,this.representation=r,this.neighbors=n,this.#e=void 0,this.position=dummyPosition}mul(e){if(0===e.rank)return this;if(0===this.rank)return e;let t=this;for(let r=0;r<e.representation.length;r++){const n=e.representation.charCodeAt(r);if(Number.isNaN(n))break;t=t.neighbors[n-Representation.beginCodePoint]}return t}calcPosition(e,t){if(this.position=e,0!==this.rank){for(let e=this.representation.length-1;e>=0;e--){const r=this.representation.charCodeAt(e);if(Number.isNaN(r))break;const n=t[r-Representation.beginCodePoint];this.position=n.reflection(this.position)}console.log(`${this.representation}: ${this.position}`)}}toString(){return this.representation}get period(){if(void 0!==this.#e)return this.#e;let e=1,t=this;for(;t.rank>0;)e++,t=t.mul(this);return this.#e=e,e}}export class SubgroupElement{source;rank;representation;neighbors;constructor(e,t,r,n){this.source=e,this.rank=t,this.representation=r,this.neighbors=n}mul(e){if(0===e.rank)return this;if(0===this.rank)return e;let t=this;for(let r=0;r<e.representation.length;r++){const n=e.representation.charCodeAt(r);if(Number.isNaN(n))break;t=t.neighbors[n-Representation.beginCodePoint]}return t}toString(){return this.representation}get index(){return this.source.index}get period(){return this.source.period}get position(){return this.source.position}}export class CoxeterGroup{ranks;matrix;order;hasPosition;isLimitOver;constructor(e){const t=e.getExchanges(),r=new CoxeterGroupElement(0,0,"",new Array(e.dimension));this.ranks=[[r]],this.matrix=e;let n=1,o=1,s=!1;const i=e.dimension>=4?14401:121,a=e.dimension>=4?31:13;for(;;){const r=this.ranks.length;console.log(`探索: rank${r}`);const c=this.ranks[r-1],l=[];for(const n of c)for(let s=0;s<e.dimension;s++){if(n.neighbors[s])continue;const i=n.representation+Representation.getChar(s);let a;for(const e of t[s]){let t=CoxeterGroup.#t(n,e.from,1);if(t&&(a=l.find(r=>t===CoxeterGroup.#t(r,e.to)),a))break}a||(a=new CoxeterGroupElement(o,r,i,new Array(e.dimension)),l.push(a),o++),a.neighbors[s]=n,n.neighbors[s]=a}if(console.log(`追加要素数: ${l.length}`),this.ranks.push(l),n+=l.length,n>=i||r>=a&&l.length>=this.ranks[this.ranks.length-2].length){s=!0;break}if(1==l.length&&l[0].neighbors.every(e=>!!e))break}r.representation="1",this.order=n,this.isLimitOver=s,this.hasPosition=!s&&CoxeterGroup.#r(this.ranks,this.matrix)}static#t(e,t,r){let n=e;for(let e=r??0;e<t.length;e++){const r=n.neighbors[t[e]];if(!r||r.rank>n.rank)return null;n=r}return n}static#r(e,t){switch(t.dimension){case 2:return CoxeterGroup.#n(e,t);case 3:return CoxeterGroup.#o(e,t);default:return!1}}static#n(e,t){if(2!==t.dimension)return!1;const r=Math.PI/t.get(0,1)*.5,n=Math.cos(r),o=Math.sin(r),s=[0,1],i=[new Mirror([n,o]),new Mirror([n,-o])];for(const t of e)for(const e of t)e.calcPosition(s,i);return!0}static#o(e,t){if(3!==t.dimension)return!1;const r=Math.cos(Math.PI/t.get(0,1)),n=Math.cos(Math.PI/t.get(1,2)),o=1-r*r-n*n;if(o<=1e-4)return!1;const s=Math.sqrt(o),i=[new Mirror([1,0,0]),new Mirror([-r,-n,s]),new Mirror([0,1,0])];let a=[s,s,1+r+n];a=Vectors.mul(a,1/Math.sqrt(Vectors.dot(a,a)));for(const t of e)for(const e of t)e.calcPosition(a,i);return!0}static parse(e){const t=e.startsWith("d");t&&(e=e.slice(1));const r=e.split(" ").filter(e=>e.length>0).map(e=>parseInt(e));return new CoxeterGroup(1==r.length?CoxeterMatrix.create2D(r[0]):2==r.length?CoxeterMatrix.create3D(r[0],r[1]):3==r.length?t?CoxeterMatrix.create4DDemicube(r[0],r[1],r[2]):CoxeterMatrix.create4D(r[0],r[1],r[2]):CoxeterMatrix.create3D(2,2))}}export class CoxeterSubgroup{parent;ranks;order;elementMap;constructor(e,t){this.parent=e;const r=t.length,n=e.ranks[0][0],o=new SubgroupElement(n,0,"",new Array(r));this.ranks=[[o]],this.elementMap=new Map,this.elementMap.set(n,o),this.order=1;let s=!0;for(;s;){s=!1;const e=this.ranks.length;console.log(`探索: rank${e}`);const n=this.ranks[e-1],o=[];for(const i of n)for(let n=0;n<r;n++){if(i.neighbors[n])continue;const a=i.source.mul(t[n]);let c=this.elementMap.get(a);if(!c){const t=i.representation+Representation.getChar(n);c=new SubgroupElement(a,e,t,new Array(r)),o.push(c),this.elementMap.set(a,c),s=!0,this.order++}i.neighbors[n]=c}console.log(`追加要素数: ${o.length}`),this.ranks.push(o)}o.representation="1"}get hasPosition(){return this.parent.hasPosition}get isLimitOver(){return this.parent.isLimitOver}}let coxeterGroup=null,selectedElement=[];class CoxeterGroupRenderer{previewFigure;lineGroup;elementGroup;orderText;constructor(e,t,r,n){this.previewFigure=e,this.lineGroup=t,this.elementGroup=r,this.orderText=n}clear(){clearChildren(this.lineGroup,this.elementGroup)}render(e){const t=new Map;let r=0,n=0;if(e.hasPosition){r=400,n=400,setCenter(200,200);for(const r of e.ranks)for(const e of r)t.set(e,Vectors.project(e.position))}else{let o=0;for(let r=0;r<e.ranks.length;r++){const n=e.ranks[r],s=40*(n.length-1);o=Math.max(o,s);const i=-s/2,a=40*r;for(let e=0;e<n.length;e++)t.set(n[e],{x:i+40*e,y:a,z:1})}r=o+60+12,n=40*(e.ranks.length-1)+60+12,setCenter(r/2,36)}clearChildren(this.lineGroup,this.elementGroup);const o=new Set,s=e.ranks.flat();s.sort((e,t)=>e.index-t.index);for(const e of s){const r=t.get(e);for(let n=0;n<e.neighbors.length;n++){const s=e.neighbors[n];if(!s)continue;const i=e.index>s.index?e.index+65536*s.index:65536*e.index+s.index;if(o.has(i))continue;o.add(i);const a=t.get(s),c=generatorColors[n%generatorColors.length]??"#000000",l=createLine(r.x,r.y,a.x,a.y,c,"4"),h=createLine(r.x,r.y,a.x,a.y,"#FFFFFF","8");this.lineGroup.prepend(l),this.lineGroup.prepend(h)}}for(const e of s){const r=t.get(e),n=0===e.rank?"#000000":"#FFFFFF",o=createCircle(r.x,r.y,6*r.z,n,"#000000","2");0!==e.rank&&(o.style.cursor="pointer",o.addEventListener("click",()=>{const t=selectedElement.indexOf(e);-1===t?(selectedElement.push(e),o.setAttribute("fill","#FF00FF")):(selectedElement.splice(t,1),o.setAttribute("fill","#FFFFFF"))})),this.elementGroup.prepend(o)}this.orderText.textContent=`order = ${e.isLimitOver?"∞":e.order}`,this.previewFigure.setAttribute("viewBox",`0 0 ${r} ${n}`)}}window.addEventListener("load",()=>{const e=document.getElementById("textarea_editor"),t=document.getElementById("button_render"),r=document.getElementById("button_subgroup"),n=document.getElementById("preview_figure"),o=document.getElementById("line_group"),s=document.getElementById("element_group"),i=document.getElementById("order_text"),a=new CoxeterGroupRenderer(n,o,s,i);t.addEventListener("click",()=>{coxeterGroup=CoxeterGroup.parse(e.value),selectedElement.length=0,a.render(coxeterGroup)}),r.addEventListener("click",()=>{!coxeterGroup||selectedElement.length<1||(coxeterGroup=new CoxeterSubgroup(coxeterGroup,[...selectedElement]),selectedElement.length=0,a.render(coxeterGroup))})});