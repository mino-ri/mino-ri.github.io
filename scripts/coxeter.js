import{clearChildren,createCircle,createLine,setCenter}from"./svg_generator.js";const generatorColors=["#DF4121","#339564","#217BDF","#C3B827"];class Representation{static beginCodePoint=97;static charMap=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p"];static getChar(e){return e<this.charMap.length?this.charMap[e]:String.fromCodePoint(Representation.beginCodePoint+e)}static getAlternating(e,t,r){const n=this.getChar(e),o=this.getChar(t),s=new Array(r),i=new Array(r);for(let e=0;e<r;e++)e%2==0?(s[e]=n,i[e]=o):(s[e]=o,i[e]=n);return[s.join(""),i.join("")]}static getAlternatingNumbers(e,t,r){const n=new Array(r),o=new Array(r);for(let s=0;s<r;s++)s%2==0?(n[s]=e,o[s]=t):(n[s]=t,o[s]=e);return[n,o]}}export class CoxeterMatrix{values;dimension;constructor(e){this.values=e;const t=this.values.length;this.dimension=Math.sqrt(2*t+.25)+.5}get(e,t){if(e==t)return 2;const r=e>t?e*(e-1)/2+t:t*(t-1)/2+e;return this.values[r]??2}getExchanges(){const e=new Array(3);for(let t=0;t<this.dimension;t++)e[t]=[];for(let t=0;t<this.dimension;t++)for(let r=t+1;r<this.dimension;r++){const n=this.get(t,r),[o,s]=Representation.getAlternatingNumbers(t,r,n);e[t]?.push({from:o,to:s}),e[r]?.push({from:s,to:o})}return e}static create2D(e){return new CoxeterMatrix([e])}static create3D(e,t,r){return new CoxeterMatrix([e,r??2,t])}static create4D(e,t,r){return new CoxeterMatrix([e,2,t,2,2,r])}static create4DDemicube(e,t,r){return new CoxeterMatrix([e,t,2,r,2,2])}}export class CoxeterGroupElement{index;rank;representation;neighbors;#e;constructor(e,t,r,n){this.index=e,this.rank=t,this.representation=r,this.neighbors=n,this.#e=void 0}mul(e){if(0===e.rank)return this;if(0===this.rank)return e;let t=this;for(let r=0;r<e.representation.length;r++){const n=e.representation.charCodeAt(r);if(Number.isNaN(n))break;t=t.neighbors[n-Representation.beginCodePoint]}return t}toString(){return this.representation}get period(){if(void 0!==this.#e)return this.#e;let e=1,t=this;for(;t.rank>0;)e++,t=t.mul(this);return this.#e=e,e}}export class SubgroupElement{source;rank;representation;neighbors;constructor(e,t,r,n){this.source=e,this.rank=t,this.representation=r,this.neighbors=n}mul(e){if(0===e.rank)return this;if(0===this.rank)return e;let t=this;for(let r=0;r<e.representation.length;r++){const n=e.representation.charCodeAt(r);if(Number.isNaN(n))break;t=t.neighbors[n-Representation.beginCodePoint]}return t}toString(){return this.representation}get index(){return this.source.index}get period(){return this.source.period}}export class CoxeterGroup{ranks;matrix;order;constructor(e){const t=e.getExchanges(),r=new CoxeterGroupElement(0,0,"",new Array(e.dimension));this.ranks=[[r]],this.matrix=e;let n=1,o=1;const s=e.dimension>=4?14401:121,i=e.dimension>=4?31:13;for(;;){const r=this.ranks.length;console.log(`探索: rank${r}`);const a=this.ranks[r-1],l=[];for(const n of a)for(let s=0;s<e.dimension;s++){if(n.neighbors[s])continue;const i=n.representation+Representation.getChar(s);let a;for(const e of t[s]){let t=CoxeterGroup.#t(n,e.from,1);if(t&&(a=l.find(r=>t===CoxeterGroup.#t(r,e.to)),a))break}a||(a=new CoxeterGroupElement(o,r,i,new Array(e.dimension)),l.push(a),o++),a.neighbors[s]=n,n.neighbors[s]=a}if(console.log(`追加要素数: ${l.length}`),this.ranks.push(l),n+=l.length,n>=s||r>=i&&l.length>=this.ranks[this.ranks.length-2].length)break;if(1==l.length&&l[0].neighbors.every(e=>!!e))break}r.representation="1",this.order=n}static#t(e,t,r){let n=e;for(let e=r??0;e<t.length;e++){const r=n.neighbors[t[e]];if(!r||r.rank>n.rank)return null;n=r}return n}static parse(e){const t=e.startsWith("d");t&&(e=e.slice(1));const r=e.split(" ").filter(e=>e.length>0).map(e=>parseInt(e));return new CoxeterGroup(1==r.length?CoxeterMatrix.create2D(r[0]):2==r.length?CoxeterMatrix.create3D(r[0],r[1]):3==r.length?t?CoxeterMatrix.create4DDemicube(r[0],r[1],r[2]):CoxeterMatrix.create4D(r[0],r[1],r[2]):CoxeterMatrix.create3D(2,2))}}export class CoxeterSubgroup{parent;ranks;order;elementMap;constructor(e,t){this.parent=e;const r=t.length,n=e.ranks[0][0],o=new SubgroupElement(n,0,"",new Array(r));this.ranks=[[o]],this.elementMap=new Map,this.elementMap.set(n,o),this.order=1;let s=!0;for(;s;){s=!1;const e=this.ranks.length;console.log(`探索: rank${e}`);const n=this.ranks[e-1],o=[];for(const i of n)for(let n=0;n<r;n++){if(i.neighbors[n])continue;const a=i.source.mul(t[n]);let l=this.elementMap.get(a);if(!l){const t=i.representation+Representation.getChar(n);l=new SubgroupElement(a,e,t,new Array(r)),o.push(l),this.elementMap.set(a,l),s=!0,this.order++}i.neighbors[n]=l}console.log(`追加要素数: ${o.length}`),this.ranks.push(o)}o.representation="1"}}let coxeterGroup=null,selectedElement=[];class CoxeterGroupRenderer{previewFigure;lineGroup;elementGroup;orderText;constructor(e,t,r,n){this.previewFigure=e,this.lineGroup=t,this.elementGroup=r,this.orderText=n}clear(){clearChildren(this.lineGroup,this.elementGroup)}render(e){const t=new Map;let r=0;for(let n=0;n<e.ranks.length;n++){const o=e.ranks[n],s=40*(o.length-1);r=Math.max(r,s);const i=-s/2,a=40*n;for(let e=0;e<o.length;e++)t.set(o[e],{x:i+40*e,y:a})}const n=r+60+12,o=40*(e.ranks.length-1)+60+12;setCenter(n/2,36),clearChildren(this.lineGroup,this.elementGroup);const s=new Set;for(const r of e.ranks)for(const e of r){const r=t.get(e);for(let n=0;n<e.neighbors.length;n++){const o=e.neighbors[n];if(!o)continue;const i=e.index>o.index?e.index+65536*o.index:65536*e.index+o.index;if(s.has(i))continue;s.add(i);const a=t.get(o),l=generatorColors[n%generatorColors.length]??"#000000",c=createLine(r.x,r.y,a.x,a.y,l,"4");this.lineGroup.appendChild(c)}}for(const r of e.ranks)for(const e of r){const r=t.get(e),n=0===e.rank?"#000000":"#FFFFFF",o=createCircle(r.x,r.y,6,n,"#000000","2");0!==e.rank&&(o.style.cursor="pointer",o.addEventListener("click",()=>{const t=selectedElement.indexOf(e);-1===t?(selectedElement.push(e),o.setAttribute("fill","#FFFF00")):(selectedElement.splice(t,1),o.setAttribute("fill","#FFFFFF"))})),this.elementGroup.appendChild(o)}this.orderText.textContent=`order = ${e.order}`,this.previewFigure.setAttribute("viewBox",`0 0 ${n} ${o}`)}}window.addEventListener("load",()=>{const e=document.getElementById("textarea_editor"),t=document.getElementById("button_render"),r=document.getElementById("button_subgroup"),n=document.getElementById("preview_figure"),o=document.getElementById("line_group"),s=document.getElementById("element_group"),i=document.getElementById("order_text"),a=new CoxeterGroupRenderer(n,o,s,i);t.addEventListener("click",()=>{coxeterGroup=CoxeterGroup.parse(e.value),selectedElement.length=0,a.render(coxeterGroup)}),r.addEventListener("click",()=>{!coxeterGroup||selectedElement.length<1||(coxeterGroup=new CoxeterSubgroup(coxeterGroup,[...selectedElement]),selectedElement.length=0,a.render(coxeterGroup))})});