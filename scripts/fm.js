import{AudioSource,WaveData}from"./sound.js";const MAX_FREQUENCY=64,BESSEL_ITERATIONS=50,BASE_HZ=220;function besselJ(t,e){if(0===e)return 0===t?1:0;const n=Math.abs(t);let a=0,o=1,r=1;for(let t=1;t<=n;t++)r*=t;const l=e/2;let i=Math.pow(l,n);for(let t=0;t<50;t++){t>0&&(o*=t,r*=n+t,i*=l*l);const e=(t%2==0?1:-1)*i/(o*r);if(a+=e,Math.abs(e)<1e-15)break}return t<0&&t%2!=0&&(a=-a),a}function calculateSidebands(t,e,n){const a=n*Math.PI,o=new Array(64).fill(0),r=Math.ceil((64+t)/e);for(let n=-r;n<=r;n++){const r=t+n*e,l=besselJ(n,a);r>=1&&r<=64?o[r-1]+=l:r<=-1&&-r<=64&&(o[-r-1]-=l)}return o.map(Math.abs)}let inputCarrier,inputModulator,inputLevel,labelCarrier,labelModulator,labelLevel,chartContainer,waveformContainer,playingAudio=null,currentLevels=[];function renderChart(t){const e=1130,n=240,a=e/64;let o='<svg viewBox="0 0 1200 300" style="width: 100%; height: auto;">';o+='<rect x="0" y="0" width="1200" height="300" fill="#FFFFFF"/>',o+='<g transform="translate(50, 20)">';const r=[0,-10,-20,-30,-40];for(const t of r){const e=(0-t)/40*n;o+=`<line x1="0" y1="${e}" x2="1130" y2="${e}" stroke="#ccc" stroke-width="1"/>`,o+=`<text x="-8" y="${e+4}" text-anchor="end" font-size="12" fill="#666">${t}</text>`}for(let t=0;t<=64;t+=8)o+=`<text x="${t/64*e}" y="260" text-anchor="middle" font-size="12" fill="#666">${t||1}</text>`;for(let e=0;e<64;e++){const r=t[e];if(r<=0)continue;const l=20*Math.log10(r);if(l<-40)continue;const i=(Math.min(l,0)- -40)/40*n;o+=`<rect x="${e*a}" y="${n-i}" width="${a-1}" height="${i}" fill="#287950"/>`}o+='<line x1="0" y1="240" x2="1130" y2="240" stroke="#333" stroke-width="2"/>',o+="</g></svg>",chartContainer.innerHTML=o}function renderWaveform(t,e,n){const a=n*Math.PI,o=1130,r=240,l=4*Math.PI,i=1e3,u=[];for(let n=0;n<=i;n++){const o=n/i*l,r=Math.sin(t*o+a*Math.sin(e*o));u.push(r)}let d='<svg viewBox="0 0 1200 300" style="width: 100%; height: auto;">';d+='<rect x="0" y="0" width="1200" height="300" fill="#FFFFFF"/>',d+='<g transform="translate(50, 20)">';const s=[1,0,-1];for(const t of s){const e=(1-t)*r/2;d+=`<line x1="0" y1="${e}" x2="1130" y2="${e}" stroke="#ccc" stroke-width="1"/>`,d+=`<text x="-8" y="${e+4}" text-anchor="end" font-size="12" fill="#666">${t}</text>`}const c=["0","π","2π","3π","4π"];for(let t=0;t<=4;t++)d+=`<text x="${t/4*o}" y="260" text-anchor="middle" font-size="12" fill="#666">${c[t]}</text>`;let h="";for(let t=0;t<=i;t++)h+=(0===t?"M":"L")+`${t/i*o},${(1-u[t])*r/2}`;d+=`<path d="${h}" fill="none" stroke="#287950" stroke-width="2"/>`,d+='<line x1="0" y1="120" x2="1130" y2="120" stroke="#333" stroke-width="1"/>',d+="</g></svg>",waveformContainer.innerHTML=d}function playSound(){playingAudio?(playingAudio.pause(),playingAudio.currentTime=0):playingAudio=document.createElement("audio");const t=parseInt(inputCarrier.value,10),e=parseInt(inputModulator.value,10),n=parseFloat(inputLevel.value)*Math.PI,a=Math.floor(88200),o=new WaveData(a),r=220*t,l=220*e,i=Math.floor(2205);for(let t=0;t<a;t++){const e=t/44100,u=Math.sin(2*Math.PI*r*e+n*Math.sin(2*Math.PI*l*e));let d=1;t<i?d=t/i:t>a-i&&(d=(a-t)/i),o.addFloat(t,.9*u*d)}playingAudio.src=AudioSource.create(o),playingAudio.play()}function updateChart(){const t=parseInt(inputCarrier.value,10),e=parseInt(inputModulator.value,10),n=parseFloat(inputLevel.value);labelCarrier.textContent=t.toString(),labelModulator.textContent=e.toString(),labelLevel.textContent=n.toFixed(2),currentLevels=calculateSidebands(t,e,n),renderChart(currentLevels),renderWaveform(t,e,n)}window.addEventListener("load",()=>{inputCarrier=document.getElementById("input_carrier"),inputModulator=document.getElementById("input_modulator"),inputLevel=document.getElementById("input_level"),labelCarrier=document.getElementById("label_carrier"),labelModulator=document.getElementById("label_modulator"),labelLevel=document.getElementById("label_level"),chartContainer=document.getElementById("chart_container"),waveformContainer=document.getElementById("waveform_container"),inputCarrier.addEventListener("input",updateChart),inputModulator.addEventListener("input",updateChart),inputLevel.addEventListener("input",updateChart);const t=document.getElementById("button_play");t&&t.addEventListener("click",playSound),updateChart()});