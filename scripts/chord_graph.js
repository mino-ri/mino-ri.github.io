import{XLengthType,interpolateMutedNote,parsePitches}from"./pitch.js";import{ColorScheme,PitchSvgGenerator}from"./chord_graph_svg.js";import{AudioSource}from"./sound.js";let textArea,checkboxAutoSize,checkboxAngleLog,checkboxLimitYLength,checkboxIgnoreOctave,checkboxQuantize,checkboxInterpolateMuted,textEdo,editorPreview,selectXLength,previewSvg,colorScheme,svgGenerator,pitches=[],playingAudio=null;const colorPalettes=[{back:"#FEFAEE",main:"#2B2F75",sub:"#FDC6FE",fill:"#FFFFFF",pitchClass0:"#30D8D4",pitchClass1:"#25938E",pitchClass2:"#E39D11",pitchClass3:"#F24E75",pitchClass4:"#9664F0",pitchClass5:"#39A2E9"},{back:"#F4F4F6",main:"#4C5156",sub:"#AAAAAA",fill:"#FFFFFF",pitchClass0:"#11EDE8",pitchClass1:"#339564",pitchClass2:"#C3B827",pitchClass3:"#DF4121",pitchClass4:"#C838C8",pitchClass5:"#217BDF"},{back:"#676681",main:"#FFFFFF",sub:"#AAAAAA",fill:"#676681",pitchClass0:"#8CF2F6",pitchClass1:"#96CC6A",pitchClass2:"#ECD551",pitchClass3:"#F08676",pitchClass4:"#EB71C6",pitchClass5:"#C779FF"}];function loadMonzo(e){const t=textArea.value,o="o"==selectXLength.value?XLengthType.OctaveReduced:"s"==selectXLength.value?XLengthType.Shasavic:XLengthType.Integer;pitches=parsePitches(t,checkboxIgnoreOctave.checked,o),checkboxInterpolateMuted.checked&&interpolateMutedNote(pitches),svgGenerator.createSvg(pitches,{xLengthType:o,autoSize:checkboxAutoSize.checked,isAngleLog:checkboxAngleLog.checked,yLengthLimit:checkboxLimitYLength.checked,quantizeEdo:checkboxQuantize.checked?Number(textEdo.value):0}),e||saveToHash()}function createSvgUrl(){const e=(new XMLSerializer).serializeToString(previewSvg),t=new Blob([e],{type:"image/svg+xml"});return URL.createObjectURL(t)}function downloadSvg(e){e.href=createSvgUrl()}function downloadPng(){const e=document.createElement("img");e.src=createSvgUrl();const t=document.createElement("canvas");t.width=previewSvg.viewBox.baseVal.width,t.height=previewSvg.viewBox.baseVal.height;const o=t.getContext("2d");e.onload=()=>{o?.drawImage(e,0,0);const c=document.createElement("a");c.href=t.toDataURL("image/png"),c.setAttribute("download","chordGraph.png"),c.dispatchEvent(new MouseEvent("click"))}}function playSound(){if(playingAudio?(playingAudio.pause(),playingAudio.currentTime=0):playingAudio=document.createElement("audio"),0===pitches.length)return;const e=pitches.filter(e=>!e.mute).map(e=>e.originalMonzo),t=checkboxQuantize.checked?Number(textEdo.value):0;playingAudio.src=AudioSource.createFromMonzos(e,220,2,t),playingAudio.play()}function encodeHash(e){return Object.keys(e).map(t=>`${t}=${e[t]}`).join("&")}function decodeHash(e){const t={};return e.split("&").forEach(e=>{const[o,c]=e.split("=");o&&c&&(t[o]=c)}),t}function saveToHash(){const e={c:textArea.value.replace(/[^0-9x/\s]+/g,"").trim().replace(/\s+/g,"_"),i:(Number(checkboxIgnoreOctave.checked)|Number(checkboxAngleLog.checked)<<1|Number(checkboxLimitYLength.checked)<<2|Number(checkboxInterpolateMuted.checked)<<3).toString(),x:selectXLength.value,e:checkboxQuantize.checked?textEdo.value:"0"};history.replaceState(null,"",`${location.pathname}#${encodeHash(e)}`)}function loadFromHash(){const{c:e,i:t,x:o,e:c}=decodeHash(location.hash.replace("#",""));if(e&&e.length>0&&(textArea.value=e.replace(/_/g," ")),t){const e=Number(t);checkboxIgnoreOctave.checked=e%2>=1,checkboxAngleLog.checked=e%4>=2,checkboxLimitYLength.checked=e%8>=4,checkboxInterpolateMuted.checked=e%16>=8}o&&(selectXLength.value=o),c&&Number(c)>=2&&(checkboxQuantize.checked=!0,textEdo.value=Number(c).toString())}function addEventListnerById(e,t,o){const c=document.getElementById(e);c.addEventListener(t,()=>o(c))}function changeColorPalette(e){const t=colorPalettes[Number(e.value)];t&&(document.getElementById("color_back")?.setAttribute("value",t.back),document.getElementById("color_main")?.setAttribute("value",t.main),document.getElementById("color_sub")?.setAttribute("value",t.sub),document.getElementById("color_fill")?.setAttribute("value",t.fill),document.getElementById("color0")?.setAttribute("value",t.pitchClass0),document.getElementById("color1")?.setAttribute("value",t.pitchClass1),document.getElementById("color2")?.setAttribute("value",t.pitchClass2),document.getElementById("color3")?.setAttribute("value",t.pitchClass3),document.getElementById("color4")?.setAttribute("value",t.pitchClass4),document.getElementById("color5")?.setAttribute("value",t.pitchClass5),editorPreview.style.background=t.back,colorScheme.noteStroke=t.main,colorScheme.gridStroke=t.sub,colorScheme.noteFill=t.fill,colorScheme.setPitchClassColor(0,t.pitchClass0),colorScheme.setPitchClassColor(1,t.pitchClass1),colorScheme.setPitchClassColor(2,t.pitchClass2),colorScheme.setPitchClassColor(3,t.pitchClass3),colorScheme.setPitchClassColor(4,t.pitchClass4),colorScheme.setPitchClassColor(5,t.pitchClass5),loadMonzo())}window.addEventListener("load",()=>{textArea=document.getElementById("textarea_editor"),checkboxAutoSize=document.getElementById("checkbox_auto_size"),checkboxAngleLog=document.getElementById("checkbox_angle_log"),checkboxLimitYLength=document.getElementById("checkbox_limit_y_length"),checkboxIgnoreOctave=document.getElementById("checkbox_ignore_octave"),checkboxQuantize=document.getElementById("checkbox_quantize"),checkboxInterpolateMuted=document.getElementById("checkbox_interpolate_muted"),textEdo=document.getElementById("text_edo"),selectXLength=document.getElementById("selecd_x_length"),editorPreview=document.getElementById("editor_preview"),previewSvg=document.getElementById("preview_figure");const e=previewSvg.getElementById("grid"),t=previewSvg.getElementById("line_group"),o=previewSvg.getElementById("pitch_class_group");colorScheme=new ColorScheme,svgGenerator=new PitchSvgGenerator(previewSvg,e,t,o,colorScheme);const c=[textArea,checkboxAutoSize,checkboxAngleLog,checkboxLimitYLength,checkboxIgnoreOctave,checkboxQuantize,checkboxInterpolateMuted,textEdo,selectXLength];for(const e of c)e.addEventListener("input",()=>loadMonzo());addEventListnerById("a_download_svg","click",downloadSvg),addEventListnerById("a_download_png","click",downloadPng),addEventListnerById("button_play","click",playSound),addEventListnerById("color_back","input",e=>{editorPreview.style.background=e.value}),addEventListnerById("color_main","input",e=>{colorScheme.noteStroke=e.value,loadMonzo()}),addEventListnerById("color_sub","input",e=>{colorScheme.gridStroke=e.value,loadMonzo()}),addEventListnerById("color_fill","input",e=>{colorScheme.noteFill=e.value,loadMonzo()}),addEventListnerById("color0","input",e=>{colorScheme.setPitchClassColor(0,e.value),loadMonzo()}),addEventListnerById("color1","input",e=>{colorScheme.setPitchClassColor(1,e.value),loadMonzo()}),addEventListnerById("color2","input",e=>{colorScheme.setPitchClassColor(2,e.value),loadMonzo()}),addEventListnerById("color3","input",e=>{colorScheme.setPitchClassColor(3,e.value),loadMonzo()}),addEventListnerById("color4","input",e=>{colorScheme.setPitchClassColor(4,e.value),loadMonzo()}),addEventListnerById("color5","input",e=>{colorScheme.setPitchClassColor(5,e.value),loadMonzo()}),addEventListnerById("select_color_palette","input",changeColorPalette),loadFromHash(),loadMonzo(!0)});