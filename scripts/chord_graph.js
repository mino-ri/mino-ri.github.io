import{XLengthType,parsePitches}from"./pitch.js";import{ColorScheme,PitchSvgGenerator}from"./chord_graph_svg.js";import{AudioSource}from"./sound.js";let textArea,checkboxAutoSize,checkboxIgnoreOctave,radioXInteger,radioXOctaveReduced,radioXShasavic,previewSvg,colorScheme,svgGenerator,pitches=[],playingAudio=null;function loadMonzo(e){const o=textArea.value,t=radioXOctaveReduced.checked?XLengthType.OctaveReduced:radioXShasavic.checked?XLengthType.Shasavic:XLengthType.Integer;pitches=parsePitches(o,checkboxIgnoreOctave.checked,t),svgGenerator.createSvg(t,pitches,checkboxAutoSize.checked),e||saveToHash()}function createSvgUrl(){const e=(new XMLSerializer).serializeToString(previewSvg),o=new Blob([e],{type:"image/svg+xml"});return URL.createObjectURL(o)}function downloadSvg(e){e.href=createSvgUrl()}function downloadPng(){const e=document.createElement("img");e.src=createSvgUrl();const o=document.createElement("canvas");o.width=previewSvg.viewBox.baseVal.width,o.height=previewSvg.viewBox.baseVal.height;const t=o.getContext("2d");e.onload=()=>{t?.drawImage(e,0,0);const c=document.createElement("a");c.href=o.toDataURL("image/png"),c.setAttribute("download","chordGraph.png"),c.dispatchEvent(new MouseEvent("click"))}}function playSound(){playingAudio?(playingAudio.pause(),playingAudio.currentTime=0):playingAudio=document.createElement("audio"),0!==pitches.length&&(playingAudio.src=AudioSource.createFromMonzos(pitches.filter(e=>!e.mute).map(e=>e.originalMonzo),220,2),playingAudio.play())}function encodeHash(e){return Object.keys(e).map(o=>`${o}=${e[o]}`).join("&")}function decodeHash(e){const o={};return e.split("&").forEach(e=>{const[t,c]=e.split("=");t&&c&&(o[t]=c)}),o}function saveToHash(){const e={c:textArea.value.replace(/[^0-9x/\s]+/g,"").trim().replace(/\s+/g,"_"),i:checkboxIgnoreOctave.checked?"1":"0",x:radioXInteger.checked?"i":radioXOctaveReduced.checked?"o":"s"};history.replaceState(null,"",`${location.pathname}#${encodeHash(e)}`)}function loadFromHash(){const{c:e,i:o,x:t}=decodeHash(location.hash.replace("#",""));e&&e.length>0&&(textArea.value=e.replace(/_/g," ")),o&&"1"===o&&(checkboxIgnoreOctave.checked=!0),t&&("i"===t?radioXInteger.checked=!0:"o"===t?radioXOctaveReduced.checked=!0:"s"===t&&(radioXShasavic.checked=!0))}function addEventListnerById(e,o,t){const c=document.getElementById(e);c.addEventListener(o,()=>t(c))}window.addEventListener("load",()=>{textArea=document.getElementById("textarea_editor"),checkboxAutoSize=document.getElementById("checkbox_auto_size"),checkboxIgnoreOctave=document.getElementById("checkbox_ignore_octave"),radioXInteger=document.getElementById("radio_x_integer"),radioXOctaveReduced=document.getElementById("radio_x_octave_reduced"),radioXShasavic=document.getElementById("radio_x_shasavic"),previewSvg=document.getElementById("preview_figure");const e=previewSvg.getElementById("grid"),o=previewSvg.getElementById("line_group"),t=previewSvg.getElementById("pitch_class_group");colorScheme=new ColorScheme,svgGenerator=new PitchSvgGenerator(previewSvg,e,o,t,colorScheme);const c=[textArea,checkboxAutoSize,checkboxIgnoreOctave,radioXInteger,radioXOctaveReduced,radioXShasavic];for(const e of c)e.addEventListener("input",()=>loadMonzo());addEventListnerById("a_download_svg","click",downloadSvg),addEventListnerById("a_download_png","click",downloadPng),addEventListnerById("button_play","click",playSound),addEventListnerById("color_main","input",e=>{colorScheme.noteStroke=e.value,loadMonzo()}),addEventListnerById("color_sub","input",e=>{colorScheme.gridStroke=e.value,loadMonzo()}),addEventListnerById("color_fill","input",e=>{colorScheme.noteFill=e.value,loadMonzo()}),addEventListnerById("color0","input",e=>{colorScheme.setPitchClassColor(0,e.value),loadMonzo()}),addEventListnerById("color1","input",e=>{colorScheme.setPitchClassColor(1,e.value),loadMonzo()}),addEventListnerById("color2","input",e=>{colorScheme.setPitchClassColor(2,e.value),loadMonzo()}),addEventListnerById("color3","input",e=>{colorScheme.setPitchClassColor(3,e.value),loadMonzo()}),addEventListnerById("color4","input",e=>{colorScheme.setPitchClassColor(4,e.value),loadMonzo()}),addEventListnerById("color5","input",e=>{colorScheme.setPitchClassColor(5,e.value),loadMonzo()}),loadFromHash(),loadMonzo(!0)});