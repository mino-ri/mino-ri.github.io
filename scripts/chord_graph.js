import{XLengthType,interpolateMutedNote,parsePitches}from"./pitch.js";import{ColorScheme}from"./svg_generator.js";import{PitchSvgGenerator}from"./chord_graph_svg.js";import{AudioSource}from"./sound.js";import{ColorControl}from"./color_palette.js";let textArea,checkboxAutoSize,checkboxAngleLog,checkboxLimitYLength,checkboxIgnoreOctave,checkboxQuantize,checkboxInterpolateMuted,textEdo,selectXLength,previewSvg,svgGenerator,colorControl,pitches=[],playingAudio=null;function loadMonzo(e){const t=textArea.value,o="o"==selectXLength.value?XLengthType.OctaveReduced:"s"==selectXLength.value?XLengthType.Shasavic:XLengthType.Integer;pitches=parsePitches(t,checkboxIgnoreOctave.checked,o),checkboxInterpolateMuted.checked&&interpolateMutedNote(pitches),svgGenerator.createSvg(pitches,{xLengthType:o,autoSize:checkboxAutoSize.checked,isAngleLog:checkboxAngleLog.checked,yLengthLimit:checkboxLimitYLength.checked,quantizeEdo:checkboxQuantize.checked?Number(textEdo.value):0}),e||saveToHash()}function createSvgUrl(){const e=(new XMLSerializer).serializeToString(previewSvg),t=new Blob([e],{type:"image/svg+xml"});return URL.createObjectURL(t)}function downloadSvg(e){e.href=createSvgUrl()}function downloadPng(){const e=document.createElement("img");e.src=createSvgUrl();const t=document.createElement("canvas");t.width=previewSvg.viewBox.baseVal.width,t.height=previewSvg.viewBox.baseVal.height;const o=t.getContext("2d");e.onload=()=>{o?.drawImage(e,0,0);const c=document.createElement("a");c.href=t.toDataURL("image/png"),c.setAttribute("download","chordGraph.png"),c.dispatchEvent(new MouseEvent("click"))}}function playSound(){if(playingAudio?(playingAudio.pause(),playingAudio.currentTime=0):playingAudio=document.createElement("audio"),0===pitches.length)return;const e=pitches.filter(e=>!e.mute).map(e=>e.originalMonzo),t=checkboxQuantize.checked?Number(textEdo.value):0;playingAudio.src=AudioSource.createFromMonzos(e,220,2,t),playingAudio.play()}function encodeHash(e){return Object.keys(e).map(t=>`${t}=${e[t]}`).join("&")}function decodeHash(e){const t={};return e.split("&").forEach(e=>{const[o,c]=e.split("=");o&&c&&(t[o]=c)}),t}function saveToHash(){const e={c:textArea.value.replace(/[^0-9x/\s]+/g,"").trim().replace(/\s+/g,"_"),i:(Number(checkboxIgnoreOctave.checked)|Number(checkboxAngleLog.checked)<<1|Number(checkboxLimitYLength.checked)<<2|Number(checkboxInterpolateMuted.checked)<<3).toString(),x:selectXLength.value,e:checkboxQuantize.checked?textEdo.value:"0"};history.replaceState(null,"",`${location.pathname}#${encodeHash(e)}`)}function loadFromHash(){const{c:e,i:t,x:o,e:c}=decodeHash(location.hash.replace("#",""));if(e&&e.length>0&&(textArea.value=e.replace(/_/g," ")),t){const e=Number(t);checkboxIgnoreOctave.checked=e%2>=1,checkboxAngleLog.checked=e%4>=2,checkboxLimitYLength.checked=e%8>=4,checkboxInterpolateMuted.checked=e%16>=8}o&&(selectXLength.value=o),c&&Number(c)>=2&&(checkboxQuantize.checked=!0,textEdo.value=Number(c).toString())}function addEventListnerById(e,t,o){const c=document.getElementById(e);c.addEventListener(t,()=>o(c))}window.addEventListener("load",()=>{textArea=document.getElementById("textarea_editor"),checkboxAutoSize=document.getElementById("checkbox_auto_size"),checkboxAngleLog=document.getElementById("checkbox_angle_log"),checkboxLimitYLength=document.getElementById("checkbox_limit_y_length"),checkboxIgnoreOctave=document.getElementById("checkbox_ignore_octave"),checkboxQuantize=document.getElementById("checkbox_quantize"),checkboxInterpolateMuted=document.getElementById("checkbox_interpolate_muted"),textEdo=document.getElementById("text_edo"),selectXLength=document.getElementById("selecd_x_length");const e=document.getElementById("editor_preview");previewSvg=document.getElementById("preview_figure");const t=previewSvg.getElementById("grid"),o=previewSvg.getElementById("line_group"),c=previewSvg.getElementById("pitch_class_group");colorControl=new ColorControl(e,new ColorScheme,()=>loadMonzo()),svgGenerator=new PitchSvgGenerator(previewSvg,t,o,c,colorControl.colorScheme);const n=[textArea,checkboxAutoSize,checkboxAngleLog,checkboxLimitYLength,checkboxIgnoreOctave,checkboxQuantize,checkboxInterpolateMuted,textEdo,selectXLength];for(const e of n)e.addEventListener("input",()=>loadMonzo());addEventListnerById("a_download_svg","click",downloadSvg),addEventListnerById("a_download_png","click",downloadPng),addEventListnerById("button_play","click",playSound),loadFromHash(),loadMonzo(!0)});