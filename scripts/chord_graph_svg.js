import{Monzo}from"./monzo.js";export class ColorScheme{gridStroke;noteStroke;noteFill;pitchScheme;constructor(){this.gridStroke="#FDC6FE",this.noteStroke="#2B2F75",this.noteFill="#FFFFFF",this.pitchScheme=[{amount:0,h:180,s:220,l:124},{amount:.25,h:177,s:152,l:92},{amount:.375,h:40,s:219,l:122},{amount:.5,h:345,s:220,l:160},{amount:.625,h:261,s:210,l:170},{amount:.75,h:204,s:203,l:145},{amount:1,h:180,s:220,l:124}]}static#t(t,e,i){t%=360,e=Math.max(0,Math.min(255,e)),i=Math.max(0,Math.min(255,i));const r=(1-Math.abs(2*i/255-1))*e/255,n=r*(1-Math.abs(t/60%2-1)),o=i/255-r/2;let h,s,a;return t<60?(h=r,s=n,a=0):t<120?(h=n,s=r,a=0):t<180?(h=0,s=r,a=n):t<240?(h=0,s=n,a=r):t<300?(h=n,s=0,a=r):(h=r,s=0,a=n),h=Math.max(0,Math.min(255,Math.round(255*(h+o)))),s=Math.max(0,Math.min(255,Math.round(255*(s+o)))),a=Math.max(0,Math.min(255,Math.round(255*(a+o)))),`#${((1<<24)+(h<<16)+(s<<8)+a).toString(16).slice(1)}`}static#e(t){t=t.replace(/^#/,"");let e=parseInt(t.substring(0,2),16)/255,i=parseInt(t.substring(2,4),16)/255,r=parseInt(t.substring(4,6),16)/255,n=Math.max(e,i,r),o=Math.min(e,i,r),h=0,s=0,a=0;if(a=(n+o)/2,n===o)h=0,s=0;else{let t=n-o;switch(s=a>.5?t/(2-n-o):t/(n+o),n){case e:h=(i-r)/t+(i<r?6:0);break;case i:h=(r-e)/t+2;break;case r:h=(e-i)/t+4}h/=6}return h=Math.round(360*h),s=Math.round(255*s),a=Math.round(255*a),{h:h,s:s,l:a}}#i(t){const e=this.pitchScheme[0],i=this.pitchScheme[this.pitchScheme.length-1];if(!e||!i)return{h:0,s:0,l:0};if(t<=e.amount)return e;if(t>=i.amount)return i;for(let e=0;e<this.pitchScheme.length-1;e++){const i=this.pitchScheme[e],r=this.pitchScheme[e+1],n=i.amount,o=r.amount;if(t>=n&&t<=o){const e=(t-n)/(o-n);let h=i.h%360,s=r.h%360-h;return s>180?s-=360:s<-180&&(s+=360),{h:(h+360+e*s)%360,s:i.s+e*(r.s-i.s),l:i.l+e*(r.l-i.l)}}}return e}setPitchClassColor(t,e){const{h:i,s:r,l:n}=ColorScheme.#e(e),o=this.pitchScheme[t];if(o&&(o.h=i,o.s=r,o.l=n),0==t){const t=this.pitchScheme[this.pitchScheme.length-1];t&&(t.h=i,t.s=r,t.l=n)}}getPitchClassColor(t){const{h:e,s:i,l:r}=this.#i(t);return ColorScheme.#t(e,i,r)}}const centerX=960,centerY=960;function getPrimePitchClass(t,e){return e?(Math.log2(t)%1+1)%1+1:t/Math.pow(2,Math.floor(Math.log2(t)))}function getIntervalDelta(t,e,i){const r=getPrimePitchClass(t,i.isAngleLog),n=(Math.log2(t)*e-i.xLengthType.getOctaveFactor(new Monzo(new Map([[t,e]]))))*i.xLengthType.scale;let o=Math.tan(Math.PI*(r-.5)),h=Math.round(2===t?0:n*o),s=null;return i.yLengthLimit&&Math.abs(h)>512&&(h=512*Math.sign(h),s={dx:Math.round(h/o),dy:h}),{dx:Math.round(n),dy:h,middlePoint:s}}function getPitchInterval(t,e){for(const[i,r]of t.factors)return getIntervalDelta(Number(i),r,e);return{dx:0,dy:0,middlePoint:null}}function getPitchPoint(t,e){let i=0,r=0;for(const[n,o]of t.factors){const{dx:t,dy:h}=getIntervalDelta(Number(n),o,e);i+=t,r+=h}return{x:i,y:r}}function clearChildren(...t){for(const e of t)for(;e.firstChild;)e.removeChild(e.firstChild)}function createPath(t,e,i,r){const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",t),n.setAttribute("fill",e),n.setAttribute("stroke",i),n.setAttribute("stroke-width",r),n}function createDiamond(t,e,i,r,n,o){return createPath(`M ${t+960},${e+960-i} l ${i},${i} l -${i},${i} l -${i},-${i} Z`,r,n,o)}function createCircle(t,e,i,r,n,o){const h=document.createElementNS("http://www.w3.org/2000/svg","circle");return h.setAttribute("cx",(t+960).toString()),h.setAttribute("cy",(e+960).toString()),h.setAttribute("r",i.toString()),h.setAttribute("fill",r),h.setAttribute("stroke",n),h.setAttribute("stroke-width",o),h}function createLine(t,e,i,r,n,o){const h=document.createElementNS("http://www.w3.org/2000/svg","line");return h.setAttribute("x1",(t+960).toString()),h.setAttribute("y1",(e+960).toString()),h.setAttribute("x2",(i+960).toString()),h.setAttribute("y2",(r+960).toString()),h.setAttribute("stroke",n),h.setAttribute("stroke-width",o),h}function createYLimitedLine(t,e,i,r,n,o,h){const{dx:s,dy:a}=n;return createPath(`M ${t+960},${e+960} C ${t+s+960},${e+a+960} ${i-s+960},${r-a+960} ${i+960},${r+960}`,"none",o,h)}function createOctaveArc(t,e,i,r,n,o,h){if(t>i){let n=t;t=i,i=n,n=e,e=r,r=n}return createPath(`M ${t+960},${e+960} A ${.625*n} ${.625*n} 0 0 0 ${i+960},${r+960}`,"none",o,h)}export class PitchSvgGenerator{previewSvg;grid;lineGroup;pitchClassGroup;colorScheme;constructor(t,e,i,r,n){this.previewSvg=t,this.grid=e,this.lineGroup=i,this.pitchClassGroup=r,this.colorScheme=n}addIntervalLine(t,e,i){const r=Monzo.divide(e,t);if(1!==r.pitchDistance)return;const{x:n,y:o}=getPitchPoint(t,i),{dx:h,dy:s,middlePoint:a}=getPitchInterval(r,i),c=n+h,l=o+s,u=Math.pow(2,Math.abs(r.pitch)%1)-1;if(r.isOnly2){const t=createOctaveArc(n,o,c,l,i.xLengthType.scale,this.colorScheme.gridStroke,"12");t.setAttribute("data-prime",r.minPrime.toString()),this.lineGroup.appendChild(t)}else{const t=this.colorScheme.getPitchClassColor(u),e=a?createYLimitedLine(n,o,c,l,a,t,"24"):createLine(n,o,c,l,t,"24"),i=r.minPrime;if(e.setAttribute("data-prime",i.toString()),this.lineGroup.firstChild)for(let t=this.lineGroup.firstChild;null!==t;t=t.nextSibling){if(t instanceof SVGElement&&t.dataset.prime&&("2"===t.dataset.prime||i<Number(t.dataset.prime))){this.lineGroup.insertBefore(e,t);break}t.nextSibling||this.lineGroup.appendChild(e)}else this.lineGroup.appendChild(e)}}createSvg(t,e){clearChildren(this.grid,this.lineGroup,this.pitchClassGroup);let i=!0,r=-50,n=-50,o=50,h=150;for(const{mute:s,monzo:a}of t){const{x:t,y:c}=getPitchPoint(a,e);r=Math.min(r,Math.round(t-50)),n=Math.min(n,Math.round(c-50)),o=Math.max(o,Math.round(t+50)),h=Math.max(h,Math.round(c+150)),s?this.pitchClassGroup.appendChild(createCircle(t,c,15,this.colorScheme.noteFill,this.colorScheme.gridStroke,"6")):i?(this.pitchClassGroup.appendChild(createDiamond(t,c,40,this.colorScheme.noteFill,this.colorScheme.noteStroke,"6")),this.pitchClassGroup.appendChild(createDiamond(t,c,30,this.colorScheme.noteStroke,this.colorScheme.noteFill,"2")),i=!1):this.pitchClassGroup.appendChild(createDiamond(t,c,30,this.colorScheme.noteFill,this.colorScheme.noteStroke,"6"))}e.autoSize?this.previewSvg.setAttribute("viewBox",`${r+960} ${n+960} ${o-r} ${h-n}`):this.previewSvg.setAttribute("viewBox","0 0 1920 1920");for(let i=0;i<t.length;i++)for(let r=i+1;r<t.length;r++)this.addIntervalLine(t[i].monzo,t[r].monzo,e)}}