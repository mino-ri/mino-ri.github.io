import{Monzo}from"./monzo.js";export class ColorScheme{gridStroke;noteStroke;noteFill;pitchScheme;constructor(){this.gridStroke="#FDC6FE",this.noteStroke="#2B2F75",this.noteFill="#FFFFFF",this.pitchScheme=[{amount:0,h:180,s:220,l:124},{amount:.25,h:177,s:152,l:92},{amount:.375,h:40,s:219,l:122},{amount:.5,h:345,s:220,l:160},{amount:.625,h:261,s:210,l:170},{amount:.75,h:204,s:203,l:145},{amount:1,h:180,s:220,l:124}]}static#t(t,e,i){t%=360,e=Math.max(0,Math.min(255,e)),i=Math.max(0,Math.min(255,i));const r=(1-Math.abs(2*i/255-1))*e/255,o=r*(1-Math.abs(t/60%2-1)),n=i/255-r/2;let h,s,c;return t<60?(h=r,s=o,c=0):t<120?(h=o,s=r,c=0):t<180?(h=0,s=r,c=o):t<240?(h=0,s=o,c=r):t<300?(h=o,s=0,c=r):(h=r,s=0,c=o),h=Math.max(0,Math.min(255,Math.round(255*(h+n)))),s=Math.max(0,Math.min(255,Math.round(255*(s+n)))),c=Math.max(0,Math.min(255,Math.round(255*(c+n)))),`#${((1<<24)+(h<<16)+(s<<8)+c).toString(16).slice(1)}`}static#e(t){t=t.replace(/^#/,"");let e=parseInt(t.substring(0,2),16)/255,i=parseInt(t.substring(2,4),16)/255,r=parseInt(t.substring(4,6),16)/255,o=Math.max(e,i,r),n=Math.min(e,i,r),h=0,s=0,c=0;if(c=(o+n)/2,o===n)h=0,s=0;else{let t=o-n;switch(s=c>.5?t/(2-o-n):t/(o+n),o){case e:h=(i-r)/t+(i<r?6:0);break;case i:h=(r-e)/t+2;break;case r:h=(e-i)/t+4}h/=6}return h=Math.round(360*h),s=Math.round(255*s),c=Math.round(255*c),{h:h,s:s,l:c}}#i(t){const e=this.pitchScheme[0],i=this.pitchScheme[this.pitchScheme.length-1];if(!e||!i)return{h:0,s:0,l:0};if(t<=e.amount)return e;if(t>=i.amount)return i;for(let e=0;e<this.pitchScheme.length-1;e++){const i=this.pitchScheme[e],r=this.pitchScheme[e+1],o=i.amount,n=r.amount;if(t>=o&&t<=n){const e=(t-o)/(n-o);let h=i.h%360,s=r.h%360-h;return s>180?s-=360:s<-180&&(s+=360),{h:(h+360+e*s)%360,s:i.s+e*(r.s-i.s),l:i.l+e*(r.l-i.l)}}}return e}setPitchClassColor(t,e){const{h:i,s:r,l:o}=ColorScheme.#e(e),n=this.pitchScheme[t];if(n&&(n.h=i,n.s=r,n.l=o),0==t){const t=this.pitchScheme[this.pitchScheme.length-1];t&&(t.h=i,t.s=r,t.l=o)}}getPitchClassColor(t){const{h:e,s:i,l:r}=this.#i(t);return ColorScheme.#t(e,i,r)}}const centerX=960,centerY=960;function getPrimePitchClass(t){return t/Math.pow(2,Math.floor(Math.log2(t)))}function getIntervalDelta(t,e,i){const r=getPrimePitchClass(t),o=Math.log2(t)*e-i.getOctaveFactor(new Monzo(new Map([[t,e]]))),n=2===t?0:o*Math.tan(Math.PI*(r-.5));return{dx:Math.round(o*i.scale),dy:Math.round(n*i.scale)}}function getPitchPoint(t,e){let i=0,r=0;for(const[o,n]of t.factors){const{dx:t,dy:h}=getIntervalDelta(Number(o),n,e);i+=t,r+=h}return{x:i,y:r}}function clearChildren(...t){for(const e of t)for(;e.firstChild;)e.removeChild(e.firstChild)}function createPath(t,e,i,r){const o=document.createElementNS("http://www.w3.org/2000/svg","path");return o.setAttribute("d",t),o.setAttribute("fill",e),o.setAttribute("stroke",i),o.setAttribute("stroke-width",r),o}function createDiamond(t,e,i,r,o,n){return createPath(`M ${t+960},${e+960-i} l ${i},${i} l -${i},${i} l -${i},-${i} Z`,r,o,n)}function createCircle(t,e,i,r,o,n){const h=document.createElementNS("http://www.w3.org/2000/svg","circle");return h.setAttribute("cx",(t+960).toString()),h.setAttribute("cy",(e+960).toString()),h.setAttribute("r",i.toString()),h.setAttribute("fill",r),h.setAttribute("stroke",o),h.setAttribute("stroke-width",n),h}function createLine(t,e,i,r,o,n){const h=document.createElementNS("http://www.w3.org/2000/svg","line");return h.setAttribute("x1",(t+960).toString()),h.setAttribute("y1",(e+960).toString()),h.setAttribute("x2",(i+960).toString()),h.setAttribute("y2",(r+960).toString()),h.setAttribute("stroke",o),h.setAttribute("stroke-width",n),h}function createOctaveArc(t,e,i,r,o,n,h){if(t>i){let o=t;t=i,i=o,o=e,e=r,r=o}return createPath(`M ${t+960},${e+960} A ${.625*o} ${.625*o} 0 0 0 ${i+960},${r+960}`,"none",n,h)}export class PitchSvgGenerator{previewSvg;grid;lineGroup;pitchClassGroup;colorScheme;constructor(t,e,i,r,o){this.previewSvg=t,this.grid=e,this.lineGroup=i,this.pitchClassGroup=r,this.colorScheme=o}addIntervalLine(t,e,i){const r=Monzo.divide(t,e);if(1!==r.pitchDistance)return;const{x:o,y:n}=getPitchPoint(t,i),{x:h,y:s}=getPitchPoint(e,i),c=Math.pow(2,Math.abs(r.pitch)%1)-1;if(r.isOnly2){const t=createOctaveArc(o,n,h,s,i.scale,this.colorScheme.gridStroke,"12");t.setAttribute("data-prime",r.minPrime.toString()),this.lineGroup.appendChild(t)}else{const t=createLine(o,n,h,s,this.colorScheme.getPitchClassColor(c),"24"),e=r.minPrime;if(t.setAttribute("data-prime",e.toString()),this.lineGroup.firstChild)for(let i=this.lineGroup.firstChild;null!==i;i=i.nextSibling){if(i instanceof SVGElement&&i.dataset.prime&&("2"===i.dataset.prime||e<Number(i.dataset.prime))){this.lineGroup.insertBefore(t,i);break}i.nextSibling||this.lineGroup.appendChild(t)}else this.lineGroup.appendChild(t)}}createSvg(t,e,i){clearChildren(this.grid,this.lineGroup,this.pitchClassGroup);let r=!0,o=-50,n=-50,h=50,s=150;for(const{mute:i,monzo:c}of e){const{x:e,y:a}=getPitchPoint(c,t);o=Math.min(o,Math.round(e-50)),n=Math.min(n,Math.round(a-50)),h=Math.max(h,Math.round(e+50)),s=Math.max(s,Math.round(a+150)),i?this.pitchClassGroup.appendChild(createCircle(e,a,15,this.colorScheme.noteFill,this.colorScheme.gridStroke,"6")):r?(this.pitchClassGroup.appendChild(createDiamond(e,a,40,this.colorScheme.noteFill,this.colorScheme.noteStroke,"6")),this.pitchClassGroup.appendChild(createDiamond(e,a,30,this.colorScheme.noteStroke,this.colorScheme.noteFill,"2")),r=!1):this.pitchClassGroup.appendChild(createDiamond(e,a,30,this.colorScheme.noteFill,this.colorScheme.noteStroke,"6"))}i?this.previewSvg.setAttribute("viewBox",`${o+960} ${n+960} ${h-o} ${s-n}`):this.previewSvg.setAttribute("viewBox","0 0 1920 1920");for(let i=0;i<e.length;i++)for(let r=i+1;r<e.length;r++)this.addIntervalLine(e[i].monzo,e[r].monzo,t)}}