import{clearChildren,createPath,createDiamond,createCircle,createLine,centerX,centerY}from"./svg_generator.js";import{Monzo}from"./monzo.js";import{XLengthType}from"./pitch.js";function getPrimePitchClass(t,e){return e?(Math.log2(t)%1+1)%1+1:t/Math.pow(2,Math.floor(Math.log2(t)))}function getIntervalDelta(t,e,i){if(2!==t&&i.quantizeEdo>1){const e=Math.round(Math.log2(t)*i.quantizeEdo)/i.quantizeEdo;t=e%1==0?2:Math.pow(2,e)}const n=getPrimePitchClass(t,i.isAngleLog),r=(Math.log2(t)*e-i.xLengthType.getOctaveFactor(new Monzo(new Map([[t,e]]))))*i.xLengthType.scale;let o=Math.tan(Math.PI*(n-.5)),h=Math.round(2===t?0:r*o),a=null;return i.yLengthLimit&&Math.abs(h)>512&&(h=512*Math.sign(h),a={dx:Math.round(h/o),dy:h}),{dx:Math.round(r),dy:h,middlePoint:a}}function getPitchInterval(t,e){for(const[i,n]of t.factors)return getIntervalDelta(Number(i),n,e);return{dx:0,dy:0,middlePoint:null}}function getPitchPoint(t,e){let i=0,n=0;for(const[r,o]of t.factors){const{dx:t,dy:h}=getIntervalDelta(Number(r),o,e);i+=t,n+=h}return{x:i,y:n}}function createYLimitedLine(t,e,i,n,r,o,h){const{dx:a,dy:s}=r;return createPath(`M ${t+centerX},${e+centerY} C ${t+a+centerX},${e+s+centerY} ${i-a+centerX},${n-s+centerY} ${i+centerX},${n+centerY}`,"none",o,h)}function createOctaveArc(t,e,i,n,r,o,h){if(t>i){let r=t;t=i,i=r,r=e,e=n,n=r}return createPath(`M ${t+centerX},${e+centerY} A ${.625*r} ${.625*r} 0 0 0 ${i+centerX},${n+centerY}`,"none",o,h)}export class PitchSvgGenerator{previewSvg;grid;lineGroup;pitchClassGroup;colorScheme;minX=-50;minY=-50;maxX=50;maxY=50;constructor(t,e,i,n,r){this.previewSvg=t,this.grid=e,this.lineGroup=i,this.pitchClassGroup=n,this.colorScheme=r}resetSize(){this.minX=-50,this.minY=-50,this.maxX=50,this.maxY=50}addPitchPoint(t,e){let i=!0;for(const{mute:n,monzo:r}of t){const{x:t,y:o}=getPitchPoint(r,e);this.minX=Math.min(this.minX,Math.round(t-50)),this.minY=Math.min(this.minY,Math.round(o-50)),this.maxX=Math.max(this.maxX,Math.round(t+50)),this.maxY=Math.max(this.maxY,Math.round(o+50)),n?this.pitchClassGroup.appendChild(createCircle(t,o,15,this.colorScheme.noteFill,this.colorScheme.gridStroke,"6")):i?(this.pitchClassGroup.appendChild(createDiamond(t,o,40,this.colorScheme.noteFill,this.colorScheme.noteStroke,"6")),this.pitchClassGroup.appendChild(createDiamond(t,o,30,this.colorScheme.noteStroke,this.colorScheme.noteFill,"2")),i=!1):this.pitchClassGroup.appendChild(createDiamond(t,o,30,this.colorScheme.noteFill,this.colorScheme.noteStroke,"6"))}}addIntervalLine(t,e,i){const n=Monzo.divide(e,t);if(1!==n.pitchDistance)return;const{x:r,y:o}=getPitchPoint(t,i),{dx:h,dy:a,middlePoint:s}=getPitchInterval(n,i),c=r+h,l=o+a,m=Math.pow(2,Math.abs(n.pitch)%1)-1;if(n.isOnly2){const t=createOctaveArc(r,o,c,l,i.xLengthType.scale,this.colorScheme.gridStroke,"12");t.setAttribute("data-prime",n.minPrime.toString()),i.xLengthType!==XLengthType.Integer&&(this.maxY=Math.max(this.maxY,Math.round(o+100))),this.lineGroup.appendChild(t)}else{const t=this.colorScheme.getPitchClassColor(m),e=s?createYLimitedLine(r,o,c,l,s,t,"24"):createLine(r,o,c,l,t,"24"),i=n.minPrime;if(e.setAttribute("data-prime",i.toString()),this.lineGroup.firstChild)for(let t=this.lineGroup.firstChild;null!==t;t=t.nextSibling){if(t instanceof SVGElement&&t.dataset.prime&&("2"===t.dataset.prime||i<Number(t.dataset.prime))){this.lineGroup.insertBefore(e,t);break}t.nextSibling||this.lineGroup.appendChild(e)}else this.lineGroup.appendChild(e)}}createSvg(t,e){clearChildren(this.grid,this.lineGroup,this.pitchClassGroup),this.resetSize(),this.addPitchPoint(t,e);for(let i=0;i<t.length;i++)for(let n=i+1;n<t.length;n++)this.addIntervalLine(t[i].monzo,t[n].monzo,e);e.autoSize?this.previewSvg.setAttribute("viewBox",`${this.minX+centerX} ${this.minY+centerY} ${this.maxX-this.minX} ${this.maxY-this.minY}`):this.previewSvg.setAttribute("viewBox","0 0 1920 1920")}}