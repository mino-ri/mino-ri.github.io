import{clearChildren,createCircle,createLine}from"./svg_generator.js";import{Monzo}from"./monzo.js";const baseSize=800;function getPitchPoint(t,e){const o=t.quantizedPitch(e.quantizeEdo)*Math.PI*2;return{x:800*Math.sin(o),y:800*-Math.cos(o)}}export class PitchClassSvgGenerator{static#t=[3,5,7,11,13,17,19,23,29,31];previewSvg;lineGroup;gridGroup;pitchClassGroup;colorScheme;constructor(t,e,o,i,r){this.previewSvg=t,this.lineGroup=e,this.gridGroup=o,this.pitchClassGroup=i,this.colorScheme=r}generate(t,e){if(clearChildren(this.lineGroup,this.gridGroup,this.pitchClassGroup),this.gridGroup.appendChild(createCircle(0,0,800,"none",this.colorScheme.gridStroke,"20")),e.showSteps&&e.quantizeEdo>0)for(let t=0;t<e.quantizeEdo;t++){const o=t/e.quantizeEdo*Math.PI*2,i=800*Math.sin(o),r=800*-Math.cos(o);this.gridGroup.appendChild(createCircle(i,r,24,this.colorScheme.gridStroke,"none","0"))}for(const o of t){const t=o.monzo,{x:i,y:r}=getPitchPoint(t,e),h=Math.pow(2,Math.log2(t.maxPrime)%1)-1,n=0===h?this.colorScheme.noteStroke:this.colorScheme.getPitchClassColor(h);o.mute?this.pitchClassGroup.appendChild(createCircle(i,r,28,this.colorScheme.gridStroke,"none","0")):(this.pitchClassGroup.appendChild(createCircle(i,r,48,this.colorScheme.noteFill,this.colorScheme.noteStroke,"6")),this.pitchClassGroup.appendChild(createCircle(i,r,32,n,"none","0")))}let o=[];e.quantizeEdo>0&&e.autoCompleteLimitInterval>0&&(o=PitchClassSvgGenerator.#t.filter(t=>t<=e.autoCompleteLimitInterval).map(t=>({step:Math.round(Math.log2(t)*e.quantizeEdo)%e.quantizeEdo,color:this.colorScheme.getPitchClassColor(Math.pow(2,Math.log2(t)%1)-1)})));for(let i=0;i<t.length;i++)for(let r=i+1;r<t.length;r++){const h=Monzo.divide(t[r].monzo,t[i].monzo),n=o.find(t=>t.step===h.quantizedStepCount(e.quantizeEdo)%e.quantizeEdo);if(!n&&1!==h.pitchDistance)continue;const c=n?.color??this.colorScheme.getPitchClassColor(Math.pow(2,Math.abs(h.pitch)%1)-1),{x:s,y:a}=getPitchPoint(t[i].monzo,e),{x:l,y:p}=getPitchPoint(t[r].monzo,e);this.lineGroup.appendChild(createLine(s,a,l,p,c,"48"))}}}